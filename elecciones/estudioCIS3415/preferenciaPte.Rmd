---
title: | 
  | ANÁLISIS UNIVARIABLE SOBRE PREFERENCIA DE PRESIDENTE/A DE GOBIERNO SEGÚN BARÓMETRO DEL CIS DE JULIO 2023
  | (ESTUDIO 3415)
subtitle: | 
  | Técnicas de Investigación en Ciencia Política I. UBU
  | Práctica 1. Apartado 3
author: "Tomàs Ferrandis Moscardó"
date: "2023-03-18"
lang: "es-ES"
fontsize: 12 pt
mainfont: "Times New Roman"
papersize: A4
linestretch: 1.5
output:
 
  pdf_document:
    toc: true
    keep_tex: true
    latex_engine: xelatex
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    df_print: paged
    number_sections: false
---
\newpage
\renewcommand\tablename{Tabla}



# 1. INTRODUCCIÓN

Esta actividad corresponde al apartado 3º de la Práctica 1 de Técnicas de Investigación en Ciencia Política I. Se trata de un *análisis univariado* sobre la variable PREFPTE del Barómetro del CIS de julio de 2023 (Estudio 3415). Concretamente se trata de la pregunta P8 que dice: *De los/las principales líderes políticos/as, ¿quién preferiría que fuese el/la presidente/a del Gobierno tras las elecciones?* . 
Obviamente al tratarse de análisis univariado solo puede ser descriptivo.

Para el análisis de los datos se usa el **lenguaje de programación R**. Se incorpora el código en los documentos renderizados (HTML y PDF) activando la opción *echo* de los chunks (*echo=TRUE*). En algunos chunks no interesa la impresión del resultado por lo que se configuran con *results='hide'*. Si se desea ver el resultado de la ejecución correcta de alguno de estos chunks bastará con eliminar el parametro *results='hide'* en el fichero Rmd descargado (ver [punto 8](#id-github) para descarga ).




# 2. OBTENCIÓN DE DATOS

```{r paquetes, echo=TRUE}
suppressMessages({ # Suprimimos mensajes de salida al...
# instalar paquetes (si no están) con las funciones...
if(!require(haven)){install.packages("haven")} # para abrir fichero .sav
if(!require(epiDisplay)){install.packages("epiDisplay")} # para gráfico 
if(!require(knitr)){install.packages("knitr")}#tabla dinámica Rmd y otros
if(!require(xlsx)){install.packages("xlsx")} # manejo de ficheros .xlsx
})
```
## 2.1 Fichero y Datos en Abierto

Del portal del CIS, se localiza el *barómetro de julio 2023* y se descargan los datos estadísticos en un formato de fichero *.sav*

Se usará una variable R (*nombreFichero*) con la ruta relativa *DATOS* que será el directorio donde se guardará los ficheros de datos.

```{r rutas,echo=TRUE}
# El fichero .sav se guardará en una subcarpeta DATOS
nombreFichero<-"datosjulio2023.sav"
directorioTrabajo<-getwd()
rutaFichero<-paste(directorioTrabajo,"DATOS",nombreFichero,sep="/")
```
## 2.2 Creación de la base de datos (*data frame*)

A partir del fichero de tipo *sav* se creará el objeto *data frame* de R. Este data frame será la base de datos inicial con todos los datos obtenidos de la muestra mediante la encuesta.

```{r, lecturaDatos, echo=TRUE, results='hide'}

df_cisjulio<-read_sav(rutaFichero)
```

## 2.3 Consultar el cuestionario y el diccionario de datos

Observando el cuestionario del CIS se puede ver qué se trata de una variable de tipo cualitativa. Una comprobación que se puede hacer mediante R es ver que los valores existentes en la base de datos coinciden coherentemente con las respuestas válidas del cuestionario. 
Mediante la función *unique* devuelve todos valores existentes en la columna sin duplicados, además de un listado de los valores posibles y sus respectiva etiquetas definidos. Puede ser de gran ayuda para esta comprobación.


```{r observacion, echo=TRUE, results='hide'}
unique(df_cisjulio$PREFPTE) # obtiene los valores sin duplicado 
```

## 2.4 Tipo de variable PREFPTE

A la vista de los resultados anteriores y, tras leer la documentación del cuestionario, se puede deducir que la variable PREFTE es una variable *cualitativa nominal* con escasos valores como es habitual (11) y, donde cada uno de ellos tiene una etiqueta asociada.

Antes de obtener medidas de posición o de variación se deberá tratar previamente la matriz de datos.

\newpage

# 3. PREPARACIÓN DE LA MATRIZ DE DATOS

A partir de la matriz obtenida se procederá a limpiar y simplificar esta base de datos inicial.

## 3.1 Limpieza de la base de datos

### Reducción del tamaño de la matriz de datos

Al tratarse de un *análisis univariado* en que solo se va a considerar una columna es conveniente prescindir de los demás datos usando así, un *data frame* de menor tamaño (menos columnas) y más simple.

```{r dataframeReducido, echo=TRUE, results='hide'}
df_cis<-df_cisjulio [, "PREFPTE"]
```

Para comprobar el resultado se puede usar instrucciones de lectura del data frame de R como *head* o *tail*.

```{r lectura, echo=TRUE, results='hide'}
tail(df_cis,4) # Muestra los 4 últimos casos
head(df_cis,4) # Muestra los 4 primeros casos
```

Otra comprobación interesante consiste en comparar las dimensiones de ambos *data frames*, el inicial y el resumido, con funciones de R como:

-   *dim()* Devuelve un vector con dos valores: el número total de casos (lineas del *data frame*) y el número de variables (columnas del *data frame*). 
-   *nrow()* Devuelve el número total de casos (lineas del *data frame*)
-   *ncols()* el número de variables (columnas del *data frame*)


```{r datos4, echo=TRUE, results='hide'}
dim(df_cis)
dim(df_cisjulio)
nrow(df_cis)
nrow(df_cisjulio)
ncol(df_cisjulio)

n<-nrow(df_cis) # La n del muestreo
```

Lógicamente el número de casos es `r nrow(df_cis)` en ambos *data frames*.

>`r nrow(df_cis)` es el valor **n** del muestreo


## 3.2 Recodificación

### Duplicación de la variable

Lo más prudente cuando se va a editar datos es que estos se realicen sobre una copia. Por esta razón duplicaremos la columna del *data frame*

```{r duplicarVar, echo=TRUE}
df_cis$recPREFPTE<-df_cis$PREFPTE
```

### Valores válidos y no válidos

Una vez examinados los datos en el apartado 3.2 anterior, ya se puede decidir qué valores de la variable son válidos y cuales no interesan para nuestro análisis.

*Valores válidos: niveles y etiquetas*

-   Pedro Sánchez 1
-   Alberto Núñez Feijóo 2
-   Santiago Abascal 3
-   Yolanda Díaz 4
-   Ione Belarra 10
-   Íñigo Errejón 7
-   Isabel Díaz Ayuso 8

*Valores no válidos: niveles y etiquetas*

-   (O LEER) Ninguno/a de ellos/as 97
-   (NO LEER) Otro/a 96
-   N.S. 98
-   N.C. 99

Se deberá agrupar bajo la etiqueta de NA (valor ausente) los valores 96, 97, 98 y 99. Para ello, antes se duplicará esta columna, es decir, se insertará dentro del *data frame* una segunda columna con los mismos valores. Sobre esta columna se editarán los datos (**recodificación**).

### Agrupación de valores NO válidos

Todos los valores que no son válidos para el análisis (96, 97, 98, 99 se actualizarán a NA.

Al mismo tiempo se puede simplificar el resto de valores en este caso, solo cambiándolos a [1,2,3,4,5,6 7].

```{r recodificar, echo=TRUE}
df_cis0<-df_cis
df_cis$recPREFPTE[df_cis$recPREFPTE >=96]<-NA
df_cis$recPREFPTE<-factor(df_cis$recPREFPTE,
                  levels=c(1,2,3,4,5,6,7),
                  labels=c("Pedro Sánchez", "Alberto Núñez Feijóo",
                   "Santiago Abascal","Yolanda Díaz","Ione Belarra",
                   "Íñigo Errejón","Isabel Díaz Ayuso"))
```

El tratamiento de los valores no válidos es doble. Se excluirán del análisis pero se deberá valorar su importancia. Para ello se debe ver su peso en relación al conjunto de valores. En R tenemos la función *summary* que devuelve los valores de posición central (media, mediana y moda) y los cuartiles. Se puede parametrizar para que cuente también los valores NA (remove missing values = FALSE)

```{r importanciaNA, echo=TRUE, results='hide'}
numero_na<-sum(is.na(df_cis$recPREFPTE)) # Guarda valor en variable para...
porcentaje_na<-round(mean(is.na(df_cis$recPREFPTE))*100,1) #calcular % NA
```

```{r importanciaNA2, echo=TRUE}
# Totaliza por valores, incluyendo NA)
kable(summary(df_cis$recPREFPTE, na.rm=FALSE), col.names = c("Líder","Repeticiones"), 
                                                                   caption="Summary")

```
*Importancia de los valores perdidos NA*

Hay un total de `r numero_na` lo que supone un porcentaje del `r porcentaje_na` de casos no válidos sobre el total de n=`r n`.

\newpage

# 4 MEDIDAS DE TENDENCIA CENTRAL

Al tratarse de una variable **cualitativa nominal** solo tiene sentido como medida de tendencia central la *moda*. La *mediana* y la *media*, no.

## 4.1 Moda

Para el cálculo de la moda, R no dispone de ninguna función en sus librerías, se puede usar una función de usuario como la aportada en los apuntes de la asignatura.

*Función Moda*

```{r funcionModa, echo=TRUE, results='hide'}
moda <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}
```

Una vez creada la función e incorporado su código en el documento RMarkdown (o script R) se podrá llamar y almacenar su resultado en una variable para consultas u operaciones posteriores.

```{r usofuncionModa,echo=TRUE, results='hide'}
varModa<-moda(df_cis$recPREFPTE) #llama a la función y recupera valor
```

La moda es: *`r varModa`*

\newpage

# 5. MEDIDAS DE DISPERSIÓN CENTRAL

Al tratarse de una variable cualitativa nominal no tiene sentido estudiar un comportamiento en la distribución de valores.

## 5.1 Tabla de frecuencias de Preferencia de presidente/a

En los siguientes análisis de datos se excluirán los valores no válidos.

### Frecuencias absolutas

La frecuencia absoluta indica la suma de casos que se deciden por cada uno de los candidatos.

```{r tablafrecuencias, echo=TRUE}
# La función *table* de R puede ignorar o no los NA (useNA="no"/"ifany")
# por defecto. useNA="no" (los ignora, no haría falta indicarlo)


# table(df_cis$recPREFPTE, useNA="no") # En R estrictamente

# Uso de formato RMarkdown 
kable(table(df_cis$recPREFPTE),column.width=c("30%","70%"),
  col.names = c("Líder","Repeticiones"),caption="Frecuencia absoluta")

```



### Frecuencias relativas.

La frecuencia relativa indica el porcentaje respecto al total de casos de los valores del apartado anterior. Es decir, el porcentaje de casos que se prefieren a cada candidato.

```{r tablafrecuencias1, echo=TRUE}
kable(round(prop.table(table(df_cis$recPREFPTE,useNA="no"))*100,digits=1),
      col.names = c("Líder","% de repeticiones"),caption="Frecuencia relativa")
```

-   La función *table* de R devolverá el total de casos de cada valor. *Ejemplo: Pedro Sánchez: 2731*
-   La función *prop* devolverá el tanto x 1 del valor anterior. *Ejemplo: Pedro Sánchez: 0,361*
-   Se multiplicará x 100 para obtener el porcentaje.
-   Con la función aritmética *round* se redondeará a 1 decimal como es habitual en Ciencias Sociales.

\newpage

# 6 Gráficos

Para variables nominales, se puede optar por:

-   Gráfico de barras
-   Gráfico de sectores
-   Gráfico de Pareto

En los siguientes subapartados ser verán los resultados en las diferentes opciones.

## 6.1 Gráfico de barras

Para una variable nominal como es el caso, el gráfico más adecuado es el diagrama de barras.
```{r grafico, echo=TRUE}
# Se adoptan los colores identificativos de la opción política
colores<-c("red","blue","#FF33FF","#2ecc71","#2980b9","#ab47bc","#c8e6c9")
coloresInvertidos<-rev(colores)
grafico <- tab1(df_cis$recPREFPTE,cum.percent = TRUE,
                sort.group="decreasing",xlab="% preferencia",
                decimal=1,bar.values = "percent",  
                main="Gráfico 1. Preferencia Presidencia de Gobierno",
                col=coloresInvertidos, missing = FALSE)

```
\newpage

## 6.2 Gráfico de sectores

Alternativamente se podría usar el gráfico de sectores.

```{r graficoPIE, echo=TRUE}
valores<-as.numeric(round(prop.table(table(df_cis$recPREFPTE))*100,
                                                              digits=1))
nombres<-names(round(prop.table(table(df_cis$recPREFPTE))*100,digits=1))
#vector con los índices ordenados según valor decreciente
orden<-order(valores,decreasing=TRUE)
valoresOrdenados<-valores[orden]
nombresOrdenados<-nombres[orden]
pie(valores, labels = nombres, 
    main = "Gráfico 2. Preferencia para Presidencia de Gobierno",
    col = colores, cex=0.8)
```

Como se puede observar, el gráfico de sectores no muestra con la misma claridad los porcentajes que el gráfico de barras.

## 6.3 Gráfico de Pareto

Esta otra alternativa ordena los datos y las frecuencias en sentido decreciente y muestra qué porcentaje acumulan en total las opciones representadas.

```{r graficoPareto,echo=TRUE}
valores<-as.numeric(round(prop.table(table(df_cis$recPREFPTE))*100,
                                                              digits=1))
nombres<-names(round(prop.table(table(df_cis$recPREFPTE))*100,digits=1))
# vector con los índices ordenados según valor decreciente
orden<-order(valores,decreasing=TRUE)
valoresOrdenados<-valores[orden]
nombresOrdenados<-nombres[orden]
colores=c("red","blue","#FF33FF","#2ecc71","#2980b9","#ab47bc","#c8e6c9")

# Calcular el porcentaje acumulado
porcentajeAcumulado<-cumsum(valoresOrdenados/
                              sum(as.numeric(valoresOrdenados)))*100

# Crear el gráfico de Pareto
par(mar = c(1, 2, 10, 2))  # Ajustar los márgenes del gráfico
ylim <- range(c(valoresOrdenados, porcentajeAcumulado))
ylim[2] <- ylim[2] + 10
barplot(valoresOrdenados, 
        main = "Gráfico 3. Preferencia Presidencia de Gobierno.", 
        xlab = "Candidatos", ylab = "Frecuencia", col = "lightblue")
        lines(porcentajeAcumulado, 
                type = "b", col = "red", pch = 21, bg = "red", yaxt = "n")
        axis(4, at = seq(0, 100, by = 10), 
                labels = paste0(seq(0, 100, by = 10),"%"),
                col = "red", las = 1)
        legend("topright", legend =c("Frecuencia","Porcentaje acumulado"),
                col = c("lightblue", "red"),
                lty = 1, pch = c(NA, 21), pt.bg = c(NA, "red"))
```

\newpage

# 7 GUARDAR RESULTADOS EN FICHERO EXTERNO

Los resultados de la tabla de frecuencia se van a guardar en un fichero externo en al misma carpeta donde hemos guardado los datos fuente (DATOS).

```{r mostrarTabla, echo=TRUE}

# El atributo *output.table* permite exportar los datos a una tabla. 
df_tabla<-grafico$output.table

# Se redefinen los nombres de campos
colnames(df_tabla)<-c("Frecuencia","%","%_acumulado", "%_válido",
                                            "%_acumulado válido")

# La función *knitr* mejora el formato de la tabla a mostrar en Rmd
kable(df_tabla,column.width=c("10%","20%","20%","20%","20%"),
                    caption="Tabla de distribución de frecuencias")
 
```
## 7.1 Fichero CSV (*Comma-Separated Values*)

Una opción sería crear un fichero *csv*, se trata de un fichero de texto plano que usa el ";"  o "," como carácter delimitador de campos mediante el la función *write.csv* e indicando que la primera fila contenga el nombre de los campos (row.names = TRUE)

```{r guardarTablaCSV, echo=TRUE}
# Se guarda la tabla de frecuencias en un fichero csv
write.csv(grafico, file = "DATOS/tablafrecResultado.csv",row.names=TRUE) 

```

## 7.2 Hoja de cálculo MS Excel (xlsx)

Una segunda opción sería crear una hoja de cálculo de MS Excel.

```{r guardarTablaXLSX, echo=TRUE}
# file= nombre del fichero hoja de cálculo de MSOffice
write.xlsx(grafico, file = "DATOS/tablafrecResultado.xlsx",
           sheetName = "prefpte", append = FALSE)           

```

Alternativamente se puede añadir una nueva página en un fichero excel ya existente.

  \newpage
  
  
# 8 EJECUCIÓN DEL Rmd Y REPOSITORIO DE FICHEROS {#id-github}

Para la ejecución del código R, está disponible el fichero ejecutable **preferenciaPte.Rmd** y el fichero de datos **datosjulio2023.sav** en el repositorio GitHub. En el mismo repositorio se encuentra este PDF y un fichero HTML renderizados a partir del Rmd.

El fichero *datosjulio2023.sav* debe ubicarse en una subcarpeta del directorio de trabajo con nombre *DATA*.


|![hyperlink icono](../../recursos/iconohyperlink.jpg){width=10%}||Enlace a GitHub|
|:---:|:------|:------|
|[![sav Logo](../../recursos/iconosav.png){width=10%}](https://tofermos.github.io/cienciapoliticaygestionpublica/elecciones/estudioCIS3415/DATOS/datosjulio2023.sav)|Fichero de datos tipo sav|[datosjulio2023.sav ](https://tofermos.github.io/cienciapoliticaygestionpublica/elecciones/estudioCIS3415/DATOS/datosjulio2023.sav)|
|[![Rmd Logo](../../recursos/rmarkdown.png){width=10%}](https://tofermos.github.io/cienciapoliticaygestionpublica/elecciones/estudioCIS3415/preferenciaPte.Rmd)|Fichero Rmd|[preferenciaPte.Rmd](https://tofermos.github.io/cienciapoliticaygestionpublica/elecciones/estudioCIS3415/preferenciaPte.Rmd)|
|[![HTML Logo](../../recursos/iconohtml.png){width=10%}](https://tofermos.github.io/cienciapoliticaygestionpublica/elecciones/estudioCIS3415/preferenciaPte.html)|Fichero HTML|[preferenciaPte.html](https://tofermos.github.io/cienciapoliticaygestionpublica/elecciones/estudioCIS3415/preferenciaPte.html)|
|[![PDF Logo](../../recursos/iconopdf.png){width=10%}](https://tofermos.github.io/cienciapoliticaygestionpublica/elecciones/estudioCIS3415/probabilidadVoto.pdf)|Fichero PDF|[preferenciaPte.pdf](https://tofermos.github.io/cienciapoliticaygestionpublica/elecciones/estudioCIS3415/probabilidadVoto.pdf)|
|[![Rmd Logo](../../recursos/iconogithub.png){width=20%}](https://tofermos.github.io/cienciapoliticaygestionpublica/)||[Repositorio tofermos](https://tofermos.github.io/cienciapoliticaygestionpublica/)|
